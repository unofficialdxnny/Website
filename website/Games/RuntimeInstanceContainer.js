var gdjs;(function(c){const l=new c.Logger("RuntimeInstanceContainer"),g=new c.Logger("RuntimeInstanceContainer (setup warnings)");class d{constructor(){this._allInstancesList=[];this._allInstancesListIsUpToDate=!0;this._instancesRemoved=[];this._layersCameraCoordinates={};this._debugDrawEnabled=!1;this._debugDrawShowHiddenInstances=!1;this._debugDrawShowPointsNames=!1;this._debugDrawShowCustomPoints=!1;this._instances=new Hashtable,this._instancesCache=new Hashtable,this._objects=new Hashtable,this._objectsCtor=new Hashtable,this._layers=new Hashtable}enableDebugDraw(e,t,s,n){this._debugDrawEnabled&&!e&&this.getDebuggerRenderer().clearDebugDraw(),this._debugDrawEnabled=e,this._debugDrawShowHiddenInstances=t,this._debugDrawShowPointsNames=s,this._debugDrawShowCustomPoints=n}isObjectRegistered(e){return this._objects.containsKey(e)&&this._instances.containsKey(e)&&this._objectsCtor.containsKey(e)}registerObject(e){this._objects.put(e.name,e),this._instances.put(e.name,[]);const t=c.getObjectConstructor(e.type);this._objectsCtor.put(e.name,t),t.supportsReinitialization&&this._instancesCache.put(e.name,[])}updateObject(e){this.isObjectRegistered(e.name)||l.warn("Tried to call updateObject for an object that was not registered ("+e.name+"). Call registerObject first."),this._objects.put(e.name,e)}unregisterObject(e){const t=this._instances.get(e);if(t){const s=t.slice();for(let n=0;n<s.length;n++)this.markObjectForDeletion(s[n]);this._cacheOrClearRemovedInstances()}this._objects.remove(e),this._instances.remove(e),this._instancesCache.remove(e),this._objectsCtor.remove(e)}createObjectsFrom(e,t,s,n){for(let a=0,r=e.length;a<r;++a){const i=e[a],h=i.name,o=this.createObject(h);o!==null&&(n&&(o.persistentUuid=i.persistentUuid||null),o.setPosition(i.x+t,i.y+s),o.setZOrder(i.zOrder),o.setAngle(i.angle),o.setLayer(i.layer),o.getVariables().initFrom(i.initialVariables,!0),o.extraInitializationFromInitialInstance(i))}}_setLayerDefaultZOrders(){if(this.getGame().getGameData().properties.useDeprecatedZeroAsDefaultZOrder)return;const e={},t=this.getAdhocListOfAllInstances();for(let s=0,n=t.length;s<n;++s){const a=t[s];let r=a.getLayer();const i=a.getZOrder();(e[r]===void 0||e[r]<i)&&(e[r]=i)}for(let s in e)this.getLayer(s).setDefaultZOrder(e[s]+1)}_updateLayersCameraCoordinates(e){this._layersCameraCoordinates=this._layersCameraCoordinates||{};for(const t in this._layers.items)if(this._layers.items.hasOwnProperty(t)){const s=this._layers.items[t];this._layersCameraCoordinates[t]=this._layersCameraCoordinates[t]||[0,0,0,0],this._layersCameraCoordinates[t][0]=s.getCameraX()-s.getCameraWidth()/2*e,this._layersCameraCoordinates[t][1]=s.getCameraY()-s.getCameraHeight()/2*e,this._layersCameraCoordinates[t][2]=s.getCameraX()+s.getCameraWidth()/2*e,this._layersCameraCoordinates[t][3]=s.getCameraY()+s.getCameraHeight()/2*e}}_updateLayersPreRender(){for(const e in this._layers.items)this._layers.items.hasOwnProperty(e)&&this._layers.items[e].updatePreRender(this)}_updateObjectsPreRender(){const e=this.getAdhocListOfAllInstances();for(let t=0,s=e.length;t<s;++t){const n=e[t],a=n.getRendererObject();a&&(a.visible=!n.isHidden(),a.visible&&this.getGame().getEffectsManager().updatePreRender(n.getRendererEffects(),n)),n.updatePreRender(this)}}_cacheOrClearRemovedInstances(){for(let e=0,t=this._instancesRemoved.length;e<t;++e){const s=this._instancesCache.get(this._instancesRemoved[e].getName());s&&s.length<128&&s.push(this._instancesRemoved[e])}this._instancesRemoved.length=0}_constructListOfAllInstances(){let e=0;for(const t in this._instances.items)if(this._instances.items.hasOwnProperty(t)){const s=this._instances.items[t],n=e;e+=s.length;for(let a=0,r=s.length;a<r;++a)n+a<this._allInstancesList.length?this._allInstancesList[n+a]=s[a]:this._allInstancesList.push(s[a])}this._allInstancesList.length=e,this._allInstancesListIsUpToDate=!0}getInstancesOf(e){return this._instances.items[e]}getAdhocListOfAllInstances(){return this._allInstancesListIsUpToDate||this._constructListOfAllInstances(),this._allInstancesList}_updateObjectsPreEvents(){const e=this.getAdhocListOfAllInstances();for(let t=0,s=e.length;t<s;++t){const n=e[t],a=n.getElapsedTime();if(n.hasNoForces())n.update(this);else{const r=n.getAverageForce(),i=a/1e3;n.setX(n.getX()+r.getX()*i),n.setY(n.getY()+r.getY()*i),n.update(this),n.updateForces(i)}n.updateTimers(a),e[t].stepBehaviorsPreEvents(this)}this._cacheOrClearRemovedInstances()}_updateObjectsPostEvents(){this._cacheOrClearRemovedInstances();const e=this.getAdhocListOfAllInstances();for(let t=0,s=e.length;t<s;++t)e[t].stepBehaviorsPostEvents(this);this._cacheOrClearRemovedInstances()}addObject(e){this._instances.containsKey(e.name)||this._instances.put(e.name,[]),this._instances.get(e.name).push(e),this._allInstancesListIsUpToDate=!1}getObjects(e){return this._instances.containsKey(e)||(l.info('RuntimeScene.getObjects: No instances called "'+e+'"! Adding it.'),this._instances.put(e,[])),this._instances.get(e)}createObject(e){if(!this._objectsCtor.containsKey(e)||!this._objects.containsKey(e))return null;const t=this._instancesCache.get(e),s=this._objectsCtor.get(e);let n;return!t||t.length===0?n=new s(this,this._objects.get(e)):(n=t.pop(),n.reinitialize(this._objects.get(e))),this.addObject(n),n}markObjectForDeletion(e){if(this._instancesRemoved.indexOf(e)===-1&&this._instancesRemoved.push(e),this._instances.containsKey(e.getName())){const t=e.id,s=this._instances.get(e.getName());for(let n=0,a=s.length;n<a;++n)if(s[n].id==t){s.splice(n,1),this._allInstancesListIsUpToDate=!1;break}}e.onDestroyFromScene(this);for(let t=0;t<c.callbacksObjectDeletedFromScene.length;++t)c.callbacksObjectDeletedFromScene[t](this,e)}getLayer(e){return this._layers.containsKey(e)?this._layers.get(e):this._layers.get("")}hasLayer(e){return this._layers.containsKey(e)}addLayer(e){this._layers.put(e.name,new c.Layer(e,this))}removeLayer(e){const t=this.getAdhocListOfAllInstances();for(let s=0;s<t.length;++s){const n=t[s];n.getLayer()===e&&n.setLayer("")}this._layers.remove(e)}setLayerIndex(e,t){const s=this._layers.get(e);!s||this.getRenderer().setLayerIndex(s,t)}getAllLayerNames(e){this._layers.keys(e)}getInstancesCountOnScene(e){const t=this._instances.get(e);return t?t.length:0}updateObjectsForces(){for(const e in this._instances.items)if(this._instances.items.hasOwnProperty(e)){const t=this._instances.items[e];for(let s=0,n=t.length;s<n;++s){const a=t[s];if(!a.hasNoForces()){const r=a.getAverageForce(),i=a.getElapsedTime()/1e3;a.setX(a.getX()+r.getX()*i),a.setY(a.getY()+r.getY()*i),a.updateForces(i)}}}}_destroy(){this._layers=new Hashtable,this._objects=new Hashtable,this._instances=new Hashtable,this._instancesCache=new Hashtable,this._objectsCtor=new Hashtable,this._allInstancesList=[],this._instancesRemoved=[]}}c.RuntimeInstanceContainer=d})(gdjs||(gdjs={}));
//# sourceMappingURL=RuntimeInstanceContainer.js.map
